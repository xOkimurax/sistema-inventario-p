import React, { useEffect, useState } from 'react';
import { supabase } from '../../lib/supabase';
import { Producto, CartItem } from '../../types';
import { ShoppingCart, Search, Plus, Minus, Trash2, Check, Package, Edit2 } from 'lucide-react';
import { formatGuaranies, parseGuaranies } from '../../utils/currency';
import { useAuth } from '../../contexts/AuthContext';
import { toast } from 'sonner';
import { AlertModal } from '../common/AlertModal';
import { ConfirmModal } from '../common/ConfirmModal';

export const Ventas: React.FC = () => {
  const [productos, setProductos] = useState<Producto[]>([]);
  const [cart, setCart] = useState<CartItem[]>([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [loading, setLoading] = useState(false);
  const [showAbrirPaquete, setShowAbrirPaquete] = useState(false);
  const [productoAbrir, setProductoAbrir] = useState<Producto | null>(null);
  const [cantidadPaquetes, setCantidadPaquetes] = useState('1');
  const [editingItemIndex, setEditingItemIndex] = useState<number | null>(null);
  const [editingCantidad, setEditingCantidad] = useState('');
  const [productoPorSeleccionar, setProductoPorSeleccionar] = useState<Producto | null>(null);
  const { user } = useAuth();

  // Alert modal
  const [alertModal, setAlertModal] = useState<{
    isOpen: boolean;
    title: string;
    message: string;
    type: 'error' | 'warning' | 'info' | 'success';
  }>({
    isOpen: false,
    title: '',
    message: '',
    type: 'info'
  });

  // Confirm modal para abrir paquete
  const [confirmAbrirPaquete, setConfirmAbrirPaquete] = useState<{
    isOpen: boolean;
    producto: Producto | null;
  }>({
    isOpen: false,
    producto: null
  });

  useEffect(() => {
    loadProductos();
  }, []);

  const loadProductos = async () => {
    try {
      const { data, error } = await supabase
        .from('productos')
        .select('*')
        .eq('is_active', true)
        .order('nombre');

      if (error) throw error;
      if (data) setProductos(data);
    } catch (error) {
      console.error('Error cargando productos:', error);
    }
  };

  const addToCart = (producto: Producto, unidad_medida: 'unidad' | 'paquete' | 'kg') => {
    let precio_unitario = 0;

    if (unidad_medida === 'unidad') {
      precio_unitario = producto.precio_venta_unidad || 0;
    } else if (unidad_medida === 'paquete') {
      precio_unitario = producto.precio_venta_paquete || 0;
    } else if (unidad_medida === 'kg') {
      precio_unitario = producto.precio_venta_kg || 0;
    }

    const existingItem = cart.find(
      item => item.producto.id === producto.id && item.unidad_medida === unidad_medida
    );

    if (existingItem) {
      // Si ya existe, abrir modal de ediciÃ³n para kg
      if (unidad_medida === 'kg') {
        const index = cart.findIndex(item => item.producto.id === producto.id && item.unidad_medida === unidad_medida);
        setEditingItemIndex(index);
        setEditingCantidad(existingItem.cantidad.toString());
      } else {
        updateQuantity(producto.id, unidad_medida, existingItem.cantidad + 1);
      }
    } else {
      // Si es por kg, abrir modal de ediciÃ³n inmediatamente
      if (unidad_medida === 'kg') {
        const newItem: CartItem = {
          producto,
          cantidad: 1,
          unidad_medida,
          precio_unitario,
          subtotal: precio_unitario
        };
        setCart([...cart, newItem]);
        setEditingItemIndex(cart.length);
        setEditingCantidad('1');
      } else {
        const newItem: CartItem = {
          producto,
          cantidad: 1,
          unidad_medida,
          precio_unitario,
          subtotal: precio_unitario
        };
        setCart([...cart, newItem]);
      }
    }
  };

  const handleSaveEdit = () => {
    if (editingItemIndex === null) return;

    const nuevaCantidad = parseFloat(editingCantidad) || 0;
    if (nuevaCantidad <= 0) {
      setEditingItemIndex(null);
      setEditingCantidad('');
      return;
    }

    setCart(cart.map((item, index) => {
      if (index === editingItemIndex) {
        return {
          ...item,
          cantidad: nuevaCantidad,
          subtotal: item.precio_unitario * nuevaCantidad
        };
      }
      return item;
    }));

    setEditingItemIndex(null);
    setEditingCantidad('');
  };

  const cerrarAvisoSeleccion = () => {
    setProductoPorSeleccionar(null);
    // NO limpiar searchTerm - el usuario puede seguir viendo quÃ© buscÃ³
  };

  const updateQuantity = (productoId: string, unidad_medida: string, newQuantity: number) => {
    if (newQuantity <= 0) {
      removeFromCart(productoId, unidad_medida);
      return;
    }

    setCart(cart.map(item => {
      if (item.producto.id === productoId && item.unidad_medida === unidad_medida) {
        return {
          ...item,
          cantidad: newQuantity,
          subtotal: item.precio_unitario * newQuantity
        };
      }
      return item;
    }));
  };

  const removeFromCart = (productoId: string, unidad_medida: string) => {
    setCart(cart.filter(
      item => !(item.producto.id === productoId && item.unidad_medida === unidad_medida)
    ));
  };

  const getTotal = () => {
    return cart.reduce((sum, item) => sum + item.subtotal, 0);
  };

  const verificarStock = (): string | null => {
    for (const item of cart) {
      const producto = item.producto;
      
      if (item.unidad_medida === 'unidad') {
        if (producto.stock_unidades < item.cantidad) {
          if (producto.tipo === 'paquete' && producto.stock_paquetes > 0) {
            return `${producto.nombre}: No hay suficientes unidades sueltas. Â¿Deseas abrir un paquete?`;
          }
          return `${producto.nombre}: Stock insuficiente`;
        }
      } else if (item.unidad_medida === 'paquete') {
        if (producto.stock_paquetes < item.cantidad) {
          return `${producto.nombre}: Stock insuficiente de paquetes`;
        }
      } else if (item.unidad_medida === 'kg') {
        if (producto.stock_kg < item.cantidad) {
          return `${producto.nombre}: Stock insuficiente en kg`;
        }
      }
    }
    
    return null;
  };

  const handleAbrirPaquete = async () => {
    if (!productoAbrir) return;

    try {
      setLoading(true);
      
      const { data, error } = await supabase.functions.invoke('abrir-paquete', {
        body: {
          producto_id: productoAbrir.id,
          cantidad_paquetes: parseInt(cantidadPaquetes)
        }
      });

      if (error) throw error;

      toast.success('Paquete abierto exitosamente');
      setShowAbrirPaquete(false);
      setProductoAbrir(null);
      setCantidadPaquetes('1');
      loadProductos();
    } catch (error: any) {
      console.error('Error abriendo paquete:', error);
      toast.error(error.message || 'Error al abrir paquete');
    } finally {
      setLoading(false);
    }
  };

  const procesarVenta = async () => {
    if (cart.length === 0) {
      setAlertModal({
        isOpen: true,
        title: 'Carrito VacÃ­o',
        message: 'Debes agregar al menos un producto al carrito antes de procesar la venta',
        type: 'warning'
      });
      return;
    }

    const errorStock = verificarStock();
    if (errorStock) {
      if (errorStock.includes('Â¿Deseas abrir un paquete?')) {
        const producto = cart.find(item => errorStock.includes(item.producto.nombre))?.producto;
        if (producto) {
          setConfirmAbrirPaquete({
            isOpen: true,
            producto: producto
          });
        }
      } else {
        setAlertModal({
          isOpen: true,
          title: 'Stock Insuficiente',
          message: errorStock,
          type: 'error'
        });
      }
      return;
    }

    try {
      setLoading(true);

      const items = cart.map(item => ({
        producto_id: item.producto.id,
        cantidad: item.cantidad,
        unidad_medida: item.unidad_medida,
        precio_unitario: item.precio_unitario
      }));

      const { data, error } = await supabase.functions.invoke('procesar-venta', {
        body: {
          items,
          notas: ''
        }
      });

      if (error) throw error;

      toast.success('Venta procesada exitosamente');
      setCart([]);
      loadProductos();
    } catch (error: any) {
      console.error('Error procesando venta:', error);
      setAlertModal({
        isOpen: true,
        title: 'Error al Procesar Venta',
        message: error.message || 'OcurriÃ³ un error al procesar la venta',
        type: 'error'
      });
    } finally {
      setLoading(false);
    }
  };

  const filteredProductos = productos.filter(p =>
    p.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
    p.codigo.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const handleSearchKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter' && searchTerm.trim()) {
      // Verificar si hay exactamente 1 producto filtrado
      if (filteredProductos.length === 1) {
        const producto = filteredProductos[0];
        console.log('Producto encontrado:', producto);
        console.log('Tipo:', producto.tipo, 'Pesable:', producto.pesable);
        
        // Verificar si se vende por unidad (tipo 'unidad' y no pesable)
        if (producto.tipo === 'unidad' && !producto.pesable && producto.stock_unidades > 0) {
          console.log('Agregando por unidad');
          addToCart(producto, 'unidad');
          setSearchTerm(''); // Limpiar bÃºsqueda
          toast.success(`${producto.nombre} agregado al carrito`);
        }
        // Productos por paquete que tambiÃ©n tienen precio por unidad - REQUIEREN SELECCIÃ“N
        else if (producto.tipo === 'paquete' && producto.precio_venta_unidad) {
          console.log('Producto paquete con opciones mÃºltiples - requiere selecciÃ³n');
          setProductoPorSeleccionar(producto);
          // NO limpiar bÃºsqueda hasta que usuario elija
          toast.info('Este producto se puede vender por unidad o por paquete. Selecciona una opciÃ³n.');
        }
        // Productos por paquete simples
        else if (producto.tipo === 'paquete' && producto.stock_paquetes > 0) {
          console.log('Agregando por paquete');
          addToCart(producto, 'paquete');
          setSearchTerm(''); // Limpiar bÃºsqueda
          toast.success(`${producto.nombre} agregado al carrito`);
        }
        // Productos unidad pesables
        else if (producto.tipo === 'unidad' && producto.pesable && producto.stock_kg > 0) {
          console.log('Agregando por kg');
          addToCart(producto, 'kg');
          setSearchTerm(''); // Limpiar bÃºsqueda
          toast.success(`${producto.nombre} agregado al carrito`);
        }
        else {
          console.log('No se puede agregar. Stock disponible:', {
            stock_unidades: producto.stock_unidades,
            stock_paquetes: producto.stock_paquetes,
            stock_kg: producto.stock_kg
          });
          toast.error('No hay stock disponible para este producto');
        }
      } else if (filteredProductos.length === 0) {
        toast.error('No se encontrÃ³ ningÃºn producto');
      } else {
        toast.error(`Se encontraron ${filteredProductos.length} productos. SÃ© mÃ¡s especÃ­fico en la bÃºsqueda`);
      }
    }
  };

  return (
    <div className="p-6">
      <h1 className="text-3xl font-bold text-gray-800 mb-6">Punto de Venta (POS)</h1>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2 space-y-6">
          <div className="bg-white rounded-xl shadow-md p-6">
            <div className="flex items-center gap-2 mb-4">
              <Search className="w-5 h-5 text-gray-400" />
              <input
                type="text"
                placeholder="Buscar producto... (Presiona Enter para agregar automÃ¡ticamente)"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                onKeyDown={handleSearchKeyDown}
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[600px] overflow-y-auto">
              {filteredProductos.map((producto) => (
                <div
                  key={producto.id}
                  className={`relative border border-gray-200 rounded-lg p-4 hover:shadow-md transition ${
                    productoPorSeleccionar?.id === producto.id 
                      ? 'border-yellow-400 bg-yellow-50 shadow-lg' 
                      : ''
                  }`}
                >
                  {/* Recuadro pequeÃ±o de selecciÃ³n al lado derecho */}
                  {productoPorSeleccionar?.id === producto.id && (
                    <div className="absolute -right-2 top-1/2 transform -translate-y-1/2 z-10 animate-pulse">
                      <div className="bg-yellow-400 text-white rounded-lg p-3 shadow-lg border-2 border-white max-w-xs">
                        <div className="text-center mb-2">
                          <div className="text-sm font-bold mb-2">Â¡SelecciÃ³n Requerida!</div>
                          <div className="text-xs mb-2">Â¿Vender por paquete o unidad?</div>
                        </div>
                        <div className="flex space-x-2">
                          <button
                            onClick={() => {
                              if (productoPorSeleccionar.stock_paquetes > 0) {
                                addToCart(productoPorSeleccionar, 'paquete');
                                setSearchTerm('');
                                cerrarAvisoSeleccion();
                              } else {
                                toast.error('No hay stock de paquetes disponible');
                              }
                            }}
                            disabled={productoPorSeleccionar.stock_paquetes <= 0}
                            className="flex-1 px-2 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-700 transition disabled:opacity-50"
                          >
                            ðŸ“¦ Paquete
                          </button>
                          <button
                            onClick={() => {
                              if (productoPorSeleccionar.stock_unidades > 0) {
                                addToCart(productoPorSeleccionar, 'unidad');
                                setSearchTerm('');
                                cerrarAvisoSeleccion();
                              } else {
                                toast.error('No hay stock de unidades disponible');
                              }
                            }}
                            disabled={productoPorSeleccionar.stock_unidades <= 0}
                            className="flex-1 px-2 py-1 bg-indigo-600 text-white rounded text-xs hover:bg-indigo-700 transition disabled:opacity-50"
                          >
                            ðŸ’° Unidad
                          </button>
                        </div>
                        <button
                          onClick={cerrarAvisoSeleccion}
                          className="absolute -top-1 -right-1 bg-gray-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-gray-600"
                        >
                          Ã—
                        </button>
                      </div>
                    </div>
                  )}
                  <div className="pr-20">
                  <div className="flex items-start justify-between mb-3">
                    <div>
                      <h3 className="font-semibold text-gray-800">{producto.nombre}</h3>
                      <p className="text-sm text-gray-500">{producto.codigo}</p>
                    </div>
                    <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                      producto.tipo === 'unidad' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'
                    }`}>
                      {producto.tipo}
                    </span>
                  </div>

                  <div className="space-y-2">
                    {producto.tipo === 'unidad' && !producto.pesable && (
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-sm text-gray-600">Precio</p>
                          <p className="font-bold text-indigo-600">{formatGuaranies(producto.precio_venta_unidad || 0)}</p>
                          <p className="text-xs text-gray-500">Stock: {Math.round(producto.stock_unidades)} unidades</p>
                        </div>
                        <button
                          onClick={() => addToCart(producto, 'unidad')}
                          disabled={producto.stock_unidades <= 0}
                          className="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50"
                        >
                          <Plus className="w-5 h-5" />
                        </button>
                      </div>
                    )}

                    {producto.tipo === 'unidad' && producto.pesable && (
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-sm text-gray-600">Precio/Kg</p>
                          <p className="font-bold text-indigo-600">{formatGuaranies(producto.precio_venta_kg || 0)}</p>
                          <p className="text-xs text-gray-500">Stock: {producto.stock_kg.toFixed(2)} kg</p>
                        </div>
                        <button
                          onClick={() => addToCart(producto, 'kg')}
                          disabled={producto.stock_kg <= 0}
                          className="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50"
                        >
                          <Plus className="w-5 h-5" />
                        </button>
                      </div>
                    )}

                    {producto.tipo === 'paquete' && (
                      <>
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm text-gray-600">Precio/Paquete</p>
                            <p className="font-bold text-indigo-600">{formatGuaranies(producto.precio_venta_paquete || 0)}</p>
                            <p className="text-xs text-gray-500">Stock: {producto.stock_paquetes} paquetes</p>
                          </div>
                          <button
                            onClick={() => addToCart(producto, 'paquete')}
                            disabled={producto.stock_paquetes <= 0}
                            className="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50"
                          >
                            <Plus className="w-5 h-5" />
                          </button>
                        </div>
                        {producto.precio_venta_unidad && (
                          <div className="flex items-center justify-between pt-2 border-t">
                            <div>
                              <p className="text-sm text-gray-600">Precio/Unidad</p>
                              <p className="font-bold text-purple-600">{formatGuaranies(producto.precio_venta_unidad)}</p>
                              <p className="text-xs text-gray-500">Stock: {Math.round(producto.stock_unidades)} unidades</p>
                            </div>
                            <button
                              onClick={() => addToCart(producto, 'unidad')}
                              disabled={producto.stock_unidades <= 0}
                              className="p-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition disabled:opacity-50"
                            >
                              <Plus className="w-5 h-5" />
                            </button>
                          </div>
                        )}
                      </>
                  </div>
                </div>
              ))}
            </div>
          </div>


        </div>

        <div className="lg:col-span-1">
          <div className="bg-white rounded-xl shadow-md p-6 sticky top-6">
            <div className="flex items-center gap-2 mb-6">
              <ShoppingCart className="w-6 h-6 text-indigo-600" />
              <h2 className="text-xl font-bold text-gray-800">Carrito</h2>
            </div>

            {cart.length === 0 ? (
              <p className="text-center text-gray-500 py-8">El carrito estÃ¡ vacÃ­o</p>
            ) : (
              <>
                <div className="space-y-3 mb-6 max-h-[400px] overflow-y-auto">
                  {cart.map((item, index) => (
                    <div key={index} className="border border-gray-200 rounded-lg p-3">
                      <div className="flex items-start justify-between mb-2">
                        <div className="flex-1">
                          <p className="font-semibold text-gray-800 text-sm">{item.producto.nombre}</p>
                          <p className="text-xs text-gray-500">
                            {formatGuaranies(item.precio_unitario)} / {item.unidad_medida}
                          </p>
                        </div>
                        <div className="flex gap-1">
                          {item.unidad_medida === 'kg' && (
                            <button
                              onClick={() => {
                                setEditingItemIndex(index);
                                setEditingCantidad(item.cantidad.toString());
                              }}
                              className="text-blue-600 hover:bg-blue-50 p-1 rounded"
                              title="Editar cantidad"
                            >
                              <Edit2 className="w-4 h-4" />
                            </button>
                          )}
                          <button
                            onClick={() => removeFromCart(item.producto.id, item.unidad_medida)}
                            className="text-red-600 hover:bg-red-50 p-1 rounded"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      </div>

                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          {item.unidad_medida !== 'kg' ? (
                            <>
                              <button
                                onClick={() => updateQuantity(item.producto.id, item.unidad_medida, item.cantidad - 1)}
                                className="p-1 bg-gray-100 rounded hover:bg-gray-200"
                              >
                                <Minus className="w-4 h-4" />
                              </button>
                              <input
                                type="number"
                                step="0.01"
                                value={item.cantidad}
                                onChange={(e) => updateQuantity(item.producto.id, item.unidad_medida, parseFloat(e.target.value) || 0)}
                                className="w-16 px-2 py-1 text-center border border-gray-300 rounded"
                              />
                              <button
                                onClick={() => updateQuantity(item.producto.id, item.unidad_medida, item.cantidad + 1)}
                                className="p-1 bg-gray-100 rounded hover:bg-gray-200"
                              >
                                <Plus className="w-4 h-4" />
                              </button>
                            </>
                          ) : (
                            <div className="px-3 py-1 bg-gray-100 rounded text-sm font-medium">
                              {item.cantidad.toFixed(2)} {item.unidad_medida}
                            </div>
                          )}
                        </div>
                        <p className="font-bold text-indigo-600">{formatGuaranies(item.subtotal)}</p>
                      </div>
                    </div>
                  ))}
                </div>

                <div className="border-t pt-4 mb-4">
                  <div className="flex items-center justify-between mb-2">
                    <p className="text-lg font-semibold text-gray-700">Total:</p>
                    <p className="text-2xl font-bold text-indigo-600">{formatGuaranies(getTotal())}</p>
                  </div>
                </div>

                <button
                  onClick={procesarVenta}
                  disabled={loading || cart.length === 0}
                  className="w-full py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                  {loading ? (
                    <>Procesando...</>
                  ) : (
                    <>
                      <Check className="w-5 h-5" />
                      Confirmar Venta
                    </>
                  )}
                </button>

                <button
                  onClick={() => setCart([])}
                  className="w-full mt-3 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
                >
                  Limpiar Carrito
                </button>
              </>
            )}
          </div>
        </div>
      </div>

      {/* Modal Abrir Paquete */}
      {showAbrirPaquete && productoAbrir && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
            <div className="flex items-center gap-2 mb-4">
              <Package className="w-6 h-6 text-indigo-600" />
              <h2 className="text-xl font-bold text-gray-800">Abrir Paquete</h2>
            </div>

            <p className="text-gray-600 mb-4">
              Â¿CuÃ¡ntos paquetes de <strong>{productoAbrir.nombre}</strong> deseas abrir?
            </p>

            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">Cantidad de Paquetes</label>
              <input
                type="number"
                min="1"
                value={cantidadPaquetes}
                onChange={(e) => setCantidadPaquetes(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              />
            </div>

            <p className="text-sm text-gray-600 mb-6">
              Se agregarÃ¡n <strong>{parseInt(cantidadPaquetes) * (productoAbrir.unidades_por_paquete || 0)}</strong> unidades al stock.
            </p>

            <div className="flex items-center gap-3">
              <button
                onClick={() => {
                  setShowAbrirPaquete(false);
                  setProductoAbrir(null);
                  setCantidadPaquetes('1');
                }}
                className="flex-1 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
              >
                Cancelar
              </button>
              <button
                onClick={handleAbrirPaquete}
                disabled={loading}
                className="flex-1 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50"
              >
                {loading ? 'Abriendo...' : 'Confirmar'}
              </button>
            </div>
          </div>
        </div>
      )}

      {editingItemIndex !== null && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Editar Cantidad (kg)</h2>
            
            <div className="mb-4">
              <p className="text-sm text-gray-600 mb-2">
                Producto: <strong>{cart[editingItemIndex]?.producto.nombre}</strong>
              </p>
              <p className="text-sm text-gray-600 mb-4">
                Precio: <strong>{formatGuaranies(cart[editingItemIndex]?.precio_unitario || 0)}/kg</strong>
              </p>
              
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Cantidad (kg)
              </label>
              <input
                type="number"
                step="0.01"
                min="0.01"
                value={editingCantidad}
                onChange={(e) => setEditingCantidad(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                autoFocus
                onKeyDown={(e) => {
                  if (e.key === 'Enter') handleSaveEdit();
                }}
              />
              
              {editingCantidad && (
                <p className="text-sm text-gray-600 mt-2">
                  Total: <strong className="text-indigo-600">
                    {formatGuaranies((parseFloat(editingCantidad) || 0) * (cart[editingItemIndex]?.precio_unitario || 0))}
                  </strong>
                </p>
              )}
            </div>

            <div className="flex items-center gap-3">
              <button
                onClick={() => {
                  setEditingItemIndex(null);
                  setEditingCantidad('');
                }}
                className="flex-1 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
              >
                Cancelar
              </button>
              <button
                onClick={handleSaveEdit}
                className="flex-1 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
              >
                Guardar
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Confirm Modal para Abrir Paquete */}
      {confirmAbrirPaquete.isOpen && confirmAbrirPaquete.producto && (
        <ConfirmModal
          isOpen={confirmAbrirPaquete.isOpen}
          title="Â¿Abrir Paquete?"
          message={`No hay suficientes unidades sueltas de "${confirmAbrirPaquete.producto.nombre}". Â¿Deseas abrir un paquete?`}
          type="warning"
          confirmText="Abrir Paquete"
          onConfirm={() => {
            setProductoAbrir(confirmAbrirPaquete.producto);
            setShowAbrirPaquete(true);
            setConfirmAbrirPaquete({ isOpen: false, producto: null });
          }}
          onCancel={() => setConfirmAbrirPaquete({ isOpen: false, producto: null })}
        />
      )}

      {/* Alert Modal */}
      <AlertModal
        isOpen={alertModal.isOpen}
        title={alertModal.title}
        message={alertModal.message}
        type={alertModal.type}
        onClose={() => setAlertModal({ ...alertModal, isOpen: false })}
      />
    </div>
  );
};
